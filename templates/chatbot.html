<!DOCTYPE html>
<html lang="en">
{% load static %}
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Chatbot - Sakhi</title>
  
  <link rel="stylesheet" href="{% static 'css/global_styles.css' %}">
  
  <style>
    /* --- Base --- */
    body, html {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }
    body {
      background: linear-gradient(to right, #e8f5e9, #c8e6c9);
      padding-top: 80px; /* Space for fixed navbar */
    }

    /* --- Navbar (RESTORED STYLES for consistency) --- */
    .navbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background-color: #2c5e2e;
        padding: 1rem 2rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        position: fixed;
        width: 100%;
        top: 0;
        left: 0; /* Added */
        z-index: 1000;
        box-sizing: border-box; /* Added */
    }
    .navbar .logo {
        font-size: 1.6rem;
        font-weight: bold;
        color: #fff;
        text-decoration: none;
    }
    .navbar .nav-links {
        display: flex;
        align-items: center;
    }
    .navbar .nav-links a {
        color: white;
        text-decoration: none;
        margin-left: 1.5rem;
        font-weight: 500;
        font-size: 1rem;
        padding: 8px 0;
        border-bottom: 2px solid transparent;
    }
    .navbar .nav-links a:hover,
    .navbar .nav-links a.active {
        color: #a7d3a6;
        border-bottom: 2px solid #a7d3a6;
    }
    .navbar .nav-auth {
        display: flex;
        align-items: center;
        gap: 1rem;
    }
    .navbar .nav-auth a.btn-auth-link {
        color: white;
        text-decoration: none;
        margin-left: 1.5rem;
        font-weight: 500;
        padding: 0.5rem 1rem;
        border: 1px solid #a7d3a6;
        border-radius: 20px;
    }
    .navbar .nav-auth a.btn-auth-link:hover {
        background-color: #a7d3a6;
        color: #2c5e2e;
    }

    /* --- Chatbot Container --- */
    .chatbot-container {
      height: 80vh; 
      max-width: 800px; 
      margin: 20px auto;
      background-color: #ffffff;
      border-radius: 16px;
      box-shadow: 0 8px 20px rgba(0, 128, 0, 0.2);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* CRITICAL FIX: Ensure header elements are correctly centered and aligned */
    .chat-header {
      background-color: #4caf50;
      color: white;
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
    }
    .chat-header span {
      font-size: 1.2rem;
      font-weight: 600;
    }
    .header-controls {
      display: flex;
      align-items: center;
      gap: 10px;
      /* Ensures controls group neatly */
    }
    .header-controls label {
        font-size: 0.9rem;
        /* Align label text */
        line-height: 1.5; 
    }
    .header-controls select {
      padding: 5px;
      border-radius: 5px;
      border: none;
      font-size: 0.9rem;
      /* Align select input */
      height: 30px; 
    }
    .header-controls button {
      background-color: #d32f2f;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1.2rem;
      line-height: 1;
    }

    .chat-box {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      background-color: #f9fbe7;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    /* --- Chat Bubbles (Self-Contained) --- */
    .user-message {
      background-color: #dcedc8;
      padding: 10px 15px;
      border-radius: 15px 15px 0 15px;
      align-self: flex-end;
      max-width: 70%;
      text-align: left;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      word-wrap: break-word;
    }
    .bot-message {
      background-color: #fff;
      padding: 10px 15px;
      border-radius: 15px 15px 15px 0;
      align-self: flex-start;
      max-width: 80%;
      text-align: left;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      border: 1px solid #e0e0e0;
      display: flex;
      gap: 10px;
      align-items: flex-start;
      word-wrap: break-word;
    }
    .bot-avatar {
      width: 35px;
      height: 35px;
      background-color: #4caf50;
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      flex-shrink: 0;
      font-size: 1.2rem;
    }
    .message-content {
      flex: 1;
      padding-top: 5px; /* Align text with avatar */
    }
    .timestamp {
      font-size: 0.75rem;
      color: #888;
      margin-top: 5px;
      display: block;
    }
    
    /* Typing Indicator (from global_styles.css) */
    .typing-indicator {
        display: flex;
        align-items: center;
        padding: 5px 0;
    }
    .typing-indicator span {
        height: 8px;
        width: 8px;
        background-color: #388e3c;
        border-radius: 50%;
        margin: 0 2px;
        animation: typing-bubble 1.4s infinite both;
    }
    .typing-indicator span:nth-child(1) { animation-delay: 0s; }
    .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
    .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
    @keyframes typing-bubble {
        0%, 80%, 100% { transform: scale(0); }
        40% { transform: scale(1); }
    }
    /* --- End Chat Bubbles --- */


    /* --- Input Area --- */
    .chat-input-container {
      padding: 15px;
      background-color: #fff;
      border-top: 1px solid #eee;
    }
    .chat-input {
      display: flex;
      gap: 10px;
    }
    .chat-input input {
      flex: 1;
      padding: 12px 20px;
      border: 1px solid #ddd;
      border-radius: 25px;
      outline: none;
      font-size: 1rem;
    }
    .chat-input input:focus {
        border-color: #4CAF50;
    }
    .chat-input button {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      border: none;
      background-color: #4caf50;
      color: white;
      font-size: 1.3rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.3s;
    }
    .chat-input button:hover {
      background-color: #388e3c;
    }
    #sendBtn {
        font-size: 1.5rem;
    }
    .mic-recording {
      background-color: #e53935 !important;
      animation: pulse-red 1.5s infinite;
    }
    @keyframes pulse-red {
        0% { box-shadow: 0 0 0 0 rgba(229, 57, 53, 0.7); }
        70% { box-shadow: 0 0 0 10px rgba(229, 57, 53, 0); }
        100% { box-shadow: 0 0 0 0 rgba(229, 57, 53, 0); }
    }
    #mic-status {
      text-align: center;
      font-size: 0.8rem;
      color: #666;
      margin-top: 5px;
      height: 15px;
    }
  </style>
  
</head>
<body>
  {% csrf_token %}

  <nav class="navbar">
     <a class="logo" href="{% url 'index' %}">
    <img src="{% static 'images/logo.png' %}" alt="Logo" style="height: 50px; vertical-align: middle; margin-right: 10px;">
    Krishi Sakhi
</a>

      <div class="nav-links">
          <a href="{% url 'index' %}">Home</a>
          <a href="{% url 'analyze_field_dashboard' %}">Analyze Field üß†</a> 
          <a href="{% url 'crop_prices' %}">Market Prices</a>
          <a href="{% url 'schemes' %}">Schemes</a>
          <a href="{% url 'weather' %}">Weather</a>
          <a href="{% url 'chatbot' %}" class="active">Chat</a>
      </div>

      <div class="nav-auth">
          {% if user.is_authenticated %}
              
              <div class="language-menu">
                  <div class="lang-icon">üåê</div>
                  <div class="dropdown-content">
                      <a href="?lang=en">English</a>
                      <a href="?lang=hi">‡§π‡§ø‡§Ç‡§¶‡•Ä (Hindi)</a>
                      <a href="?lang=ta">‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç (Tamil)</a>
                      <a href="?lang=te">‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å (Telugu)</a>
                      <a href="?lang=kn">‡≤ï‡≤®‡≥ç‡≤®‡≤° (Kannada)</a>
                  </div>
              </div>

              <div class="profile-menu">
                  <div class="profile-pic">
                      {{ user.username|first|upper|default:'K' }}
                  </div>
                  <div class="dropdown-content">
                      <div class="dropdown-header">
                          <strong>{{ user.first_name|default:user.username }}</strong>
                          <span>{{ user.email }}</span>
                      </div>
                      <a href="{% url 'profile' %}">View Profile</a>
                      <a href="{% url 'personalize' %}">My Farm</a>
                      <a href="{% url 'history' %}">Prediction History</a>
                      <a href="{% url 'logout' %}" class="logout-link">Logout</a>
                  </div>
              </div>

          {% else %}
              <a href="{% url 'login' %}" class="btn-auth-link">Login</a>
              <a href="{% url 'signup' %}" class="btn-auth-link">Sign Up</a>
          {% endif %}
      </div>
  </nav>
  <div class="chatbot-container">
    <div class="chat-header">
      <span>üåæ Sakhi - Your Smart Krishi Assistant</span>
      
      <div class="header-controls">
        <label for="lang-select">Language:</label>
        <select id="lang-select">
          <option value="en-US">English (US)</option>
          <option value="hi-IN">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä (Hindi)</option>
          <option value="mr-IN">Marathi (India)</option>
          <option value="te-IN">‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å (Telugu)</option>
          <option value="ta-IN">‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç (Tamil)</option>
          <option value="kn-IN">‡≤ï‡≤®‡≥ç‡≤®‡≤° (Kannada)</option>
          </select>
        <button id="stop-speech-btn" title="Stop Speaking">üîá</button>
      </div>
      
    </div>

    <div class="chat-box" id="chat-box">
      <div class="bot-message">
        <div class="bot-avatar">S</div>
        <div class="message-content">
            <p>Hi! I'm Sakhi üå±. How can I help you today?</p>
            <span class="timestamp">Just now</span>
        </div>
      </div>
    </div>

    <div class="chat-input-container">
      <div class="chat-input">
        <input type="text" id="user-input" placeholder="Type or click the mic..." onkeydown="handleKey(event)" />
        <button id="mic-btn" title="Speak">üé§</button>
        <button id="sendBtn" onclick="handleManualSend()">‚û§</button>
      </div>
      
      <p id="mic-status"></p>
    </div>

  </div>

  <a href="{% url 'chatbot' %}" class="chat-widget-button" title="Chat with Sakhi" style="display: none;">
      üí¨
  </a>

   <script>
    // --- 1. Setup Elements ---
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    const chatBox = document.getElementById('chat-box');
    const userInput = document.getElementById('user-input');
    const micBtn = document.getElementById('mic-btn');
    const langSelect = document.getElementById('lang-select');
    const stopSpeechBtn = document.getElementById('stop-speech-btn');
    const micStatus = document.getElementById('mic-status');
    
    // ‚úÖ State Flags
    let isVoiceInput = false; 
    let isSakhiSpeaking = false; 
    let isRecognitionRunning = false; 

    // --- 2. Text-to-Speech (TTS) Setup ---
    const synth = window.speechSynthesis;
    let voices = [];

    const voicesLoadedPromise = new Promise((resolve) => {
        const populateAndResolve = () => {
            voices = synth.getVoices();
            if (voices.length > 0) {
                resolve();
                return true;
            }
            return false;
        };
        if (!populateAndResolve()) {
            synth.onvoiceschanged = populateAndResolve;
        }
        setTimeout(() => {
            if (voices.length === 0) populateAndResolve();
            resolve();
        }, 2000); 
    });

    async function speakText(text, lang) {
      await voicesLoadedPromise;
      synth.cancel();
      
      isSakhiSpeaking = true;
      if (isRecognitionRunning && recognition) {
          recognition.stop(); 
      }

      const utterance = new SpeechSynthesisUtterance(text);
      const langShort = lang.split('-')[0];
      
      let foundVoice = voices.find(voice => 
          voice.lang.startsWith(langShort) && 
          (voice.name.toLowerCase().includes('female') || 
           voice.name.toLowerCase().includes('google'))
      );
      
      if (!foundVoice) {
          foundVoice = voices.find(voice => voice.lang.startsWith(langShort));
      }
      
      if (foundVoice) {
          utterance.voice = foundVoice;
      }
      
      utterance.rate = 1.0; 
      
      utterance.onend = () => {
          isSakhiSpeaking = false;
      };
      utterance.onerror = () => {
          isSakhiSpeaking = false;
          console.error('TTS error');
      };
      
      synth.speak(utterance);
    }
    
    stopSpeechBtn.addEventListener('click', () => {
      synth.cancel();
      isSakhiSpeaking = false; 
      micStatus.textContent = "Speech stopped.";
    });

    // --- 3. Speech-to-Text (STT) Setup ---
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition;
    
    if (SpeechRecognition) {
      recognition = new SpeechRecognition();
      recognition.continuous = false;
      recognition.interimResults = false;
      
      micBtn.addEventListener('click', () => {
        if (isRecognitionRunning) {
             recognition.stop(); 
             return;
        }
        if (isSakhiSpeaking) {
            micStatus.textContent = "Please wait, Sakhi is speaking.";
            return;
        }
        
        micStatus.textContent = "Listening... Speak clearly.";
        recognition.lang = langSelect.value;
        try {
          recognition.start();
          micBtn.classList.add('mic-recording');
          isRecognitionRunning = true; 
        } catch(e) { 
            console.error("Speech recognition start error:", e); 
        }
      });
      
      recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        userInput.value = transcript;
        micStatus.textContent = "Sending message...";
        
        isVoiceInput = true;
        
        setTimeout(sendMessage, 500); 
      };
      
      recognition.onend = () => {
        micBtn.classList.remove('mic-recording');
        isRecognitionRunning = false; 
      };
      
      recognition.onerror = (event) => {
        micBtn.classList.remove('mic-recording');
        isRecognitionRunning = false; 
        if (event.error !== 'no-speech' && event.error !== 'aborted') {
            micStatus.textContent = "Error: " + event.error;
        } else {
            micStatus.textContent = "No speech detected. Try again.";
        }
      };
      
    } else {
      micBtn.disabled = true;
      micBtn.innerHTML = "üö´";
      micStatus.textContent = "Voice input not supported in this browser.";
    }

    // --- 4. Helper Functions (Unchanged) ---
    function markdownToHTML(text) {
      let html = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
      html = html.replace(/^\*\s(.*)$/gm, '<p style="margin: 0; padding: 2px 0;">‚Ä¢ $1</p>');
      html = html.split('\n').map(line => line.trim().startsWith('<p') ? line : (line.trim() ? `<p>${line}</p>` : '')).join('');
      return html;
    }

    function getCurrentTime() {
      const now = new Date();
      return now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    // --- 5. Input Handlers (Unchanged) ---
    function handleManualSend() {
        isVoiceInput = false;
        sendMessage();
    }
    function handleKey(e) {
      if (e.key === 'Enter') {
        isVoiceInput = false;
        sendMessage();
      }
    }

    // --- 6. Main Send Message Logic ---
    async function sendMessage() {
      if (isRecognitionRunning && recognition) {
        recognition.stop(); 
      }
      if (isSakhiSpeaking) {
          micStatus.textContent = "Please wait until I finish speaking.";
          return;
      }

      const message = userInput.value.trim();
      if (message === '') return;
      
      const userMsg = document.createElement('div');
      userMsg.className = 'user-message';
      userMsg.innerHTML = `${message}<span class="timestamp">${getCurrentTime()}</span>`;
      chatBox.appendChild(userMsg);
      userInput.value = '';
      chatBox.scrollTop = chatBox.scrollHeight;
      
      const thinkingMsg = document.createElement('div');
      thinkingMsg.className = 'bot-message';
      thinkingMsg.innerHTML = `
        <div class="bot-avatar">S</div>
        <div class="message-content">
            <div class="typing-indicator"><span></span><span></span><span></span></div>
            <span class="timestamp">${getCurrentTime()}</span>
        </div>
      `;
      chatBox.appendChild(thinkingMsg);
      chatBox.scrollTop = chatBox.scrollHeight;

      try {
        const response = await fetch('{% url "chatbot_api" %}', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
          },
          body: JSON.stringify({
              message: message,
              lang: langSelect.value 
          })
        });
        
        if (!response.ok) throw new Error("Server error, check console.");
        const data = await response.json();
        const botReply = data.reply;
        
        thinkingMsg.className = 'bot-message';
        const htmlReply = markdownToHTML(botReply);
        thinkingMsg.innerHTML = `
            <div class="bot-avatar">S</div>
            <div class="message-content">
                ${htmlReply}
                <span class="timestamp">${getCurrentTime()}</span>
            </div>
        `;
        
        chatBox.scrollTop = chatBox.scrollHeight;

        const textToSpeak = botReply.replace(/[\*#]/g, '');
        const replyLang = langSelect.value;

        if (isVoiceInput) {
            speakText(textToSpeak, replyLang);
        }
        
        isVoiceInput = false;

      } catch (error) {
        console.error('Error:', error);
        thinkingMsg.className = 'bot-message';
        thinkingMsg.innerHTML = `
            <div class="bot-avatar">S</div>
            <div class="message-content">
                <p>Sorry, an error occurred: ${error.message}</p>
                <span class="timestamp">${getCurrentTime()}</span>
            </div>
        `;
      }
    }
    
    // --- 7. Preloader Script (Keeping original structure for safety) ---
    const facts = [
        "India is the world's largest producer of milk, pulses, and jute.",
        "The monsoon is often called the 'true finance minister of India'.",
        "The Green Revolution in India started in the 1960s.",
    ];
    
    const preloader = document.getElementById('preloader');
    const factText = document.getElementById('preloader-fact');
    const loaderText = document.getElementById('preloader-text');

    if (factText) {
        factText.innerHTML = facts[Math.floor(Math.random() * facts.length)];
    }
    
    let factInterval = setInterval(function() {
        if (factText) {
            factText.innerHTML = facts[Math.floor(Math.random() * facts.length)];
        }
    }, 3000);

    window.onload = () => {
        clearInterval(factInterval);
        if (preloader) {
            preloader.style.opacity = '0';
            setTimeout(() => {
                preloader.style.display = 'none';
            }, 500);
        }
    };
</script>