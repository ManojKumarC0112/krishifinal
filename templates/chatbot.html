{% extends 'base.html' %}
{% load static %}

{% block title %}Chatbot - Sakhi{% endblock %}

{% block styles %}
<style>
    /* 1. LOCK THE BODY */
    body {
        /* Prevent background scroll */
        position: fixed; 
        width: 100%;
        height: 100%;
        overflow: hidden;
    }

    /* 2. CHAT LAYOUT WRAPPER */
    .chatbot-layout-wrapper {
        position: absolute;
        top: 70px; /* Below Navbar */
        left: 0;
        right: 0;
        bottom: 0; /* Fill remaining space */
        background: #f4f7f6;
        display: flex;
        flex-direction: column;
        z-index: 1;
    }

    /* 3. HEADER (Fixed at top of chat) */
    .chat-header {
        background-color: #4caf50;
        color: white;
        padding: 10px 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        height: 50px;
        flex-shrink: 0;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        z-index: 10;
    }

    .header-controls { display: flex; gap: 10px; align-items: center; }
    .header-controls select { padding: 4px; border-radius: 4px; border: none; font-size: 0.85rem; }
    .header-controls button { background: #d32f2f; color: white; border: none; padding: 4px 8px; border-radius: 4px; }

    /* 4. SCROLLABLE MESSAGES AREA */
    .chat-box {
        flex: 1; 
        overflow-y: auto; /* Scroll enabled */
        padding: 15px;
        /* CRITICAL: Extra padding at bottom so text isn't hidden behind the input box */
        padding-bottom: 120px; 
        background-color: #f9fbe7;
        display: flex;
        flex-direction: column;
        gap: 15px;
        -webkit-overflow-scrolling: touch; /* Smooth scroll on iOS */
    }

    /* Message Bubbles */
    .user-message {
        background-color: #dcedc8;
        padding: 10px 15px;
        border-radius: 15px 15px 0 15px;
        align-self: flex-end;
        max-width: 80%;
        word-wrap: break-word;
        box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    .bot-message {
        background-color: #fff;
        padding: 10px 15px;
        border-radius: 15px 15px 15px 0;
        align-self: flex-start;
        max-width: 85%;
        border: 1px solid #ddd;
        display: flex; gap: 10px;
        box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    .bot-avatar {
        width: 30px; height: 30px; background: #4caf50; color: white;
        border-radius: 50%; display: flex; align-items: center; justify-content: center;
        font-weight: bold; flex-shrink: 0;
    }
    .timestamp { font-size: 0.7rem; color: #888; margin-top: 4px; display: block; }

    /* 5. INPUT AREA (PINNED TO GLASS) */
    /* This overrides Flexbox and sticks it to the screen bottom */
    .chat-input-container {
        position: fixed; 
        bottom: 0;
        left: 0;
        width: 100%;
        background-color: #ffffff;
        padding: 12px;
        border-top: 1px solid #ddd;
        box-shadow: 0 -4px 10px rgba(0,0,0,0.05);
        z-index: 9999; /* Always on top */
        box-sizing: border-box;
        
        /* Safety padding for iPhone X Home Bar */
        padding-bottom: calc(12px + env(safe-area-inset-bottom)); 
    }

    .chat-input {
        display: flex;
        gap: 10px;
        align-items: center;
        max-width: 800px; /* Keep it neat on desktop */
        margin: 0 auto;
    }

    .chat-input input {
        flex: 1;
        padding: 12px 15px;
        border: 2px solid #e0e0e0;
        border-radius: 25px;
        font-size: 1rem;
        outline: none;
        background: #f9f9f9;
    }
    .chat-input input:focus { border-color: #4caf50; background: #fff; }

    .chat-input button {
        width: 48px; height: 48px;
        border-radius: 50%; border: none;
        background: #4caf50; color: white;
        font-size: 1.3rem; cursor: pointer;
        display: flex; align-items: center; justify-content: center;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    /* Mobile Tweaks */
    @media (max-width: 768px) {
        .header-controls label { display: none; }
        .chat-header span { font-size: 1rem; }
    }
    
    #mic-status { text-align: center; font-size: 0.75rem; color: #666; height: 16px; margin-top: 5px;}
    .mic-recording { background-color: #e53935 !important; animation: pulse 1s infinite; }
    @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
</style>
{% endblock %}

{% block content %}
<div class="chatbot-layout-wrapper">
    <div class="chat-header">
        <span>ðŸŒ¾ Sakhi Assistant</span>
        <div class="header-controls">
            <label for="lang-select">Lang:</label>
            <select id="lang-select">
                <option value="en-US">English</option>
                <option value="hi-IN">Hindi</option>
                <option value="te-IN">Telugu</option>
                <option value="ta-IN">Tamil</option>
                <option value="kn-IN">Kannada</option>
            </select>
            <button id="stop-speech-btn" title="Stop Speaking">ðŸ”‡</button>
        </div>
    </div>

    <div class="chat-box" id="chat-box">
        <div class="bot-message">
            <div class="bot-avatar">S</div>
            <div class="message-content">
                <p>Namaste! I'm Sakhi ðŸŒ±. I can help with crops, prices, and schemes.</p>
                <span class="timestamp">Just now</span>
            </div>
        </div>
    </div>

    <div class="chat-input-container">
        <div class="chat-input">
            <input type="text" id="user-input" placeholder="Type here..." onkeydown="handleKey(event)" />
            <button id="mic-btn">ðŸŽ¤</button>
            <button id="sendBtn" onclick="handleManualSend()">âž¤</button>
        </div>
        <p id="mic-status"></p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // --- CHECK FOR HTTPS (For Live Vision/Mic) ---
    if (window.location.protocol !== 'https:' && window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1') {
        // Just a console warning, or we can alert user
        console.warn("Camera/Mic requires HTTPS. Please use Ngrok.");
    }

    // --- CHATBOT JS ---
    const csrfToken = '{{ csrf_token }}'; 
    const chatBox = document.getElementById('chat-box');
    const userInput = document.getElementById('user-input');
    const micBtn = document.getElementById('mic-btn');
    const langSelect = document.getElementById('lang-select');
    const stopSpeechBtn = document.getElementById('stop-speech-btn');
    const micStatus = document.getElementById('mic-status');
    
    let isSakhiSpeaking = false;
    let recognition; 

    function handleKey(e) { if (e.key === 'Enter') handleManualSend(); }

    async function handleManualSend() {
        const text = userInput.value.trim();
        if (!text) return;
        
        addMessage(text, 'user');
        userInput.value = '';
        const loadingId = addMessage('Thinking...', 'bot', true);

        try {
            const response = await fetch('{% url "chatbot_api" %}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                body: JSON.stringify({ message: text, lang: langSelect.value })
            });
            const data = await response.json();
            document.getElementById(loadingId).remove();
            addMessage(data.reply, 'bot');
            speakText(data.reply, langSelect.value);
        } catch (error) {
            document.getElementById(loadingId).remove();
            addMessage("Error: Please check your internet or use Ngrok (HTTPS).", 'bot');
        }
    }

    function addMessage(text, sender, isLoading=false) {
        const div = document.createElement('div');
        div.className = sender === 'user' ? 'user-message' : 'bot-message';
        div.id = 'msg-' + Date.now();
        
        if (sender === 'bot') {
            div.innerHTML = `<div class="bot-avatar">S</div><div class="message-content">${isLoading ? text : markdownToHTML(text)}<span class="timestamp">${getCurrentTime()}</span></div>`;
        } else {
            div.innerHTML = `${text}<span class="timestamp">${getCurrentTime()}</span>`;
        }
        
        chatBox.appendChild(div);
        // Scroll to the visual bottom (accounting for the fixed input padding)
        chatBox.scrollTo({ top: chatBox.scrollHeight, behavior: 'smooth' });
        return div.id;
    }

    function markdownToHTML(text) {
        let html = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        html = html.replace(/^\*\s(.*)$/gm, '<br>â€¢ $1');
        return html;
    }
    
    function getCurrentTime() {
        const now = new Date();
        return now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    function speakText(text, lang) {
        window.speechSynthesis.cancel();
        isSakhiSpeaking = true;
        const cleanText = text.replace(/[\*#]/g, '');
        const utterance = new SpeechSynthesisUtterance(cleanText);
        
        const voices = window.speechSynthesis.getVoices();
        const langShort = lang.split('-')[0];
        const voice = voices.find(v => v.lang.startsWith(langShort));
        if (voice) utterance.voice = voice;

        utterance.onend = () => { isSakhiSpeaking = false; };
        window.speechSynthesis.speak(utterance);
    }

    stopSpeechBtn.addEventListener('click', () => {
        window.speechSynthesis.cancel();
        isSakhiSpeaking = false;
    });

    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        recognition.continuous = false;

        micBtn.addEventListener('click', () => {
            if (isSakhiSpeaking) { micStatus.innerText = "Wait..."; return; }
            micBtn.classList.add('mic-recording');
            micStatus.innerText = "Listening...";
            recognition.lang = langSelect.value;
            try { recognition.start(); } catch(e) {}
        });

        recognition.onresult = (event) => {
            const transcript = event.results[0][0].transcript;
            userInput.value = transcript;
            micStatus.innerText = "Processing...";
            setTimeout(() => {
                handleManualSend();
                micBtn.classList.remove('mic-recording');
                micStatus.innerText = "";
            }, 500);
        };
        recognition.onend = () => { micBtn.classList.remove('mic-recording'); };
    } else {
        micBtn.style.display = 'none';
    }
</script>
{% endblock %}