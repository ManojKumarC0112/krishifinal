{% load static %}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Market Prices - Krishi Sakhi</title>

  <link rel="stylesheet" href="{% static 'css/global_styles.css' %}">
  <style>
    :root {
      --ks-dark: #1B5E20;
      --ks-mid: #2E7D32;
      --ks-soft: #E8F5E9;
      --ks-accent: #CDE3C8;
      --ks-text: #1f2d1f;
    }
    body { background: var(--ks-soft); color: var(--ks-text); font-family: "Segoe UI", sans-serif; }
    .container { max-width: 1180px; margin: 24px auto; padding: 0 18px; }
    .card { background:#fff; border-radius:12px; padding:22px; margin-bottom:20px; box-shadow:0 4px 14px rgba(0,0,0,0.06); }
    .wide-card { text-align:center; padding:32px; }
    .section-title { font-size:22px; font-weight:700; color:var(--ks-dark); }
    .muted { color:#6b6f63; font-size:14px; }
    .grid { display:grid; grid-template-columns:1fr 380px; gap:22px; }
    @media (max-width:950px){ .grid{ grid-template-columns:1fr; } }
    .highlight-card { border:2px solid var(--ks-accent); background:#f6fff6; padding:20px; border-radius:12px; }
    .small-card { background:#fff; padding:18px; border-radius:10px; box-shadow:0 4px 12px rgba(0,0,0,0.05); margin-bottom:16px; }
    .small-title { font-weight:700; font-size:17px; margin-bottom:8px; color:var(--ks-dark); }
    .forecast-list { display:flex; flex-wrap:wrap; gap:10px; margin-top:10px; }
    .forecast-item { background:#f7fff7; padding:10px 12px; border-radius:8px; border:1px solid var(--ks-accent); min-width:130px; }
    .price-big { font-size:28px; font-weight:800; color:var(--ks-dark); }
    .button { background:var(--ks-mid); color:#fff; padding:8px 14px; border:none; border-radius:8px; font-weight:600; cursor:pointer; }
  </style>
</head>

<body>

{% include "base.html" %}

<div class="container">

  <div class="card wide-card">
    <div class="section-title">ðŸŒ¾ Live Market Dashboard</div>

    <div class="muted" style="margin-top:8px;">
      Source: <strong>{{ data.source|default:"AI Compiled" }}</strong>
      &nbsp;|&nbsp; Updated: <strong>{{ data.date|default:"N/A" }}</strong>
    </div>

    <div style="margin-top:20px; display:flex; flex-wrap:wrap; gap:20px; justify-content:center;">

      <div>
        <div class="muted">Crop</div>
        <div style="font-weight:700; color:var(--ks-dark); font-size:18px;">
          {{ data.primary_crop|default:"Tomato" }}
        </div>
      </div>

      <div>
        <div class="muted">Current Price</div>
        {% if data.current_price %}
        <div class="price-big">â‚¹ {{ data.current_price }} / {{ data.unit|default:"Quintal" }}</div>
        {% else %}
        <div class="price-big">N/A</div>
        {% endif %}
      </div>

      <div>
        <div class="muted">Expected Change</div>
        {% if data.expected_increase_percent %}
        <div style="font-weight:700; color:{% if data.expected_increase_percent|floatformat:2 > 0 %}#2E7D32{% else %}#c62828{% endif %};">
          {{ data.expected_increase_percent|floatformat:2 }} %
        </div>
        {% else %}
        <div class="muted">N/A</div>
        {% endif %}
      </div>

      <div><button class="button" onclick="location.reload()">Refresh</button></div>

    </div>
  </div>

  <div class="grid">

    <!-- LEFT -->
    <div>

      <div class="highlight-card">
        <h3 style="margin:0; color:var(--ks-dark);">ðŸ’¡ AI Market Highlight</h3>

        <p style="margin-top:10px;">
          {% if data.highlight %}
            {{ data.highlight }}
          {% else %}
            <span class="muted">No highlight available.</span>
          {% endif %}
        </p>

        <div style="margin-top:10px;">
          <strong>Best Day to Sell</strong><br>
          {% if data.best_day.date %}
            <span class="muted">{{ data.best_day.date }} â€” â‚¹ {{ data.best_day.predicted_price }}</span>
          {% else %}
            <span class="muted">Not available</span>
          {% endif %}
        </div>

        <div style="margin-top:12px;">
          <strong>Smart Advice</strong>
          <p class="muted" style="margin-top:6px;">
            {% if data.advice %}{{ data.advice }}{% else %}No AI advice available.{% endif %}
          </p>
        </div>

      </div>

      <div class="card" style="margin-top:16px;">
        <div class="small-title">ðŸ”® 14-Day Forecast</div>

        <div class="forecast-list">
          {% if data.forecast %}
            {% for f in data.forecast %}
            <div class="forecast-item">
              <div style="font-weight:700;">{{ f.date }}</div>
              <div class="muted">â‚¹ {{ f.predicted_price }} / {{ data.unit|default:"Quintal" }}</div>
            </div>
            {% endfor %}
          {% else %}
            <span class="muted">No forecast available.</span>
          {% endif %}
        </div>

      </div>

    </div>

    <!-- RIGHT -->
    <div>

      <div class="small-card">
        <div class="small-title">ðŸ“ˆ Price Trend (30 Days)</div>

        <canvas id="priceChart" style="width:100%; height:260px;"></canvas>
      </div>

      <div class="small-card" style="margin-top:16px;">
        <div class="small-title">ðŸ“° Latest Market News</div>

        {% if data.news %}
          {% for n in data.news %}
          <div style="padding:10px 0; border-top:1px solid #eee;">
            <strong>
              {% if n.url %}
                <a href="{{ n.url }}" target="_blank" style="color:var(--ks-dark); text-decoration:none;">
                  {{ n.title }}
                </a>
              {% else %}
                {{ n.title }}
              {% endif %}
            </strong>
            <div class="muted">{{ n.source }}</div>
          </div>
          {% endfor %}
        {% else %}
          <div class="muted">No news available.</div>
        {% endif %}
      </div>

    </div>
  </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
(function(){
  const history = {{ data.history|default:"[]"|safe }};
  const ctx = document.getElementById('priceChart').getContext('2d');

  if(history.length > 0){
    history.sort((a,b)=> new Date(a.date) - new Date(b.date));
    const labels = history.map(x=>x.date);
    const prices = history.map(x=>parseFloat(x.price));

    new Chart(ctx,{
      type:'line',
      data:{
        labels:labels,
        datasets:[{
          label:"Price (â‚¹ / {{ data.unit|default:'Quintal' }})",
          data:prices,
          borderColor:"#2E7D32",
          backgroundColor:"rgba(46,125,50,0.15)",
          fill:true,
          tension:0.25,
          borderWidth:2,
          pointRadius:2
        }]
      },
      options:{
        responsive:true,
        plugins:{ legend:{ display:false } },
      }
    });

  } else {
    ctx.font="14px Arial";
    ctx.fillStyle="#888";
    ctx.fillText("No trend data available.", 20,40);
  }

})();
</script>

</body>
</html>
