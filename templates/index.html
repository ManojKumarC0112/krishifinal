{% extends 'base.html' %}
{% load static %}

{% block title %}Home - Krishi Sakhi{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{% static 'css/index.css' %}">
<style>
    /* 1. RESET LAYOUT */
    .content-wrapper { max-width: 100% !important; margin: 0 !important; padding: 0 !important; }

    /* 2. HERO SECTION */
    .hero {
        min-height: 100vh; padding-top: 80px; 
        background-size: cover; background-position: center;
        display: flex; align-items: center; justify-content: center;
        text-align: center; position: relative;
    }
    
    .hero::before {
        content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0, 0, 0, 0.4); z-index: 1;
    }

    .hero-text { position: relative; z-index: 2; color: white; }

    @media (max-width: 768px) {
        .hero-text { width: 90%; padding: 1.5rem; }
        .hero-text h1 { font-size: 2rem; }
        .hero-buttons { display: flex; flex-direction: column; gap: 15px; align-items: center; width: 100%; }
        .hero-buttons .btn { width: 100%; margin: 0 !important; }
    }

    /* --- TOUR / SPOTLIGHT STYLES --- */
    
    /* The Spotlight Circle */
    #tour-spotlight {
        position: fixed;
        border-radius: 8px; /* Matches button corners */
        box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.85); /* The dark overlay "hole" trick */
        z-index: 3000;
        pointer-events: none; /* Let clicks pass through if needed */
        transition: all 0.4s ease-in-out;
        opacity: 0; /* Hidden initially */
        border: 2px solid #fff; /* White glowing border */
    }

    /* The Text Bubble */
    #tour-tooltip {
        position: fixed;
        background: white;
        width: 280px;
        padding: 20px;
        border-radius: 12px;
        z-index: 3001;
        opacity: 0;
        transition: all 0.4s ease-in-out;
        box-shadow: 0 5px 20px rgba(0,0,0,0.3);
    }
    
    /* Tooltip Arrow */
    #tour-tooltip::after {
        content: "";
        position: absolute;
        border-width: 10px;
        border-style: solid;
        /* Position handled by JS */
    }

    .tt-title { font-size: 1.2rem; font-weight: bold; color: #2c5e2e; margin-bottom: 8px; display: flex; align-items: center; gap: 8px;}
    .tt-desc { font-size: 0.95rem; color: #555; line-height: 1.5; margin-bottom: 15px; }
    
    .tt-buttons { display: flex; justify-content: space-between; align-items: center; }
    .tt-skip { color: #888; font-size: 0.9rem; text-decoration: underline; cursor: pointer; }
    .tt-next {
        background: #4CAF50; color: white; border: none;
        padding: 8px 20px; border-radius: 20px; font-weight: bold; cursor: pointer;
    }
    
    /* Pulsing effect on spotlight */
    @keyframes pulse-border {
        0% { transform: scale(1); border-color: rgba(255,255,255,1); }
        50% { transform: scale(1.05); border-color: rgba(255,255,255,0.5); }
        100% { transform: scale(1); border-color: rgba(255,255,255,1); }
    }
    .spotlight-active { animation: pulse-border 2s infinite; }
</style>
{% endblock %}

{% block content %}
  <section class="hero">
    <div class="hero-text">
      {% if user.is_authenticated %}
        <h1 id="greeting">{{ timeGreeting|default:"Namaste" }}, {{ user.username }}! ðŸŒ¾</h1>
        <p>What would you like to do today?</p>
        
        <div class="hero-buttons">
            <a href="{% url 'analyze_field_dashboard' %}" class="btn" id="btn-analyze">Analyze Field</a>
            <a href="{% url 'crop_prices' %}" class="btn" id="btn-prices" style="background: #ffc107; color: #333; margin-left: 10px;">Check Prices</a>
        </div>
        
        <div style="margin-top: 30px;">
            <a href="#" onclick="startTour(); return false;" style="color: rgba(255,255,255,0.9); text-decoration: none; font-size: 1rem; border-bottom: 1px dotted white; padding-bottom: 2px;">
                ðŸ”„ Show Me How It Works
            </a>
        </div>
      {% else %}
        <h1>Welcome to Krishi Sakhi</h1>
        <p>Your smart farming assistant using AI ðŸŒ±</p>
        <a href="{% url 'login' %}" class="btn">Login to Start</a>
      {% endif %}
    </div>
  </section>

  <footer style="text-align: center; padding: 1rem; background-color: #006400; color: #fff; position: relative; z-index: 2;">
    <p>Â© 2025 Krishi Sakhi | By MNV Nexus ðŸŒ¾</p>
  </footer>

  <a href="{% url 'chatbot' %}" id="btn-chat-widget" class="chat-widget-button" title="Chat with Sakhi" style="
      position: fixed; bottom: 20px; right: 20px; 
      background: #4CAF50; color: white; 
      width: 60px; height: 60px; border-radius: 50%; 
      display: flex; align-items: center; justify-content: center; 
      font-size: 30px; text-decoration: none; 
      box-shadow: 0 4px 10px rgba(0,0,0,0.3); z-index: 2000;">
      ðŸ’¬
  </a>

  <div id="tour-spotlight"></div>
  <div id="tour-tooltip">
      <div class="tt-title" id="ttTitle">ðŸ“¸ Scan Crop</div>
      <div class="tt-desc" id="ttDesc">Click here to take a photo of your crop.</div>
      <div class="tt-buttons">
          <span class="tt-skip" onclick="endTour()">Skip</span>
          <button class="tt-next" id="ttBtn" onclick="nextStep()">Next</button>
      </div>
  </div>

{% endblock %}

{% block scripts %}
<script>
    // --- TOUR CONFIGURATION (MULTI-LANGUAGE) ---
    const tourData = {
        'en': [
            { target: 'btn-analyze', title: "ðŸ“¸ Detect Disease", desc: "Click this button to take a photo of your sick plant. AI will tell you the medicine." },
            { target: 'btn-chat-widget', title: "ðŸ—£ï¸ Talk to Sakhi", desc: "Click here to speak in Hindi, Tamil, or Telugu. Ask any farming question!" },
            { target: 'btn-prices', title: "ðŸ’° Market Prices", desc: "Click here to check the latest Mandi prices and Government Schemes." }
        ],
        'hi': [
            { target: 'btn-analyze', title: "ðŸ“¸ à¤¬à¥€à¤®à¤¾à¤°à¥€ à¤ªà¤¹à¤šà¤¾à¤¨à¥‡à¤‚", desc: "à¤…à¤ªà¤¨à¥€ à¤¬à¥€à¤®à¤¾à¤° à¤«à¤¸à¤² à¤•à¥€ à¤«à¥‹à¤Ÿà¥‹ à¤²à¥‡à¤¨à¥‡ à¤•à¥‡ à¤²à¤¿à¤ à¤¯à¤¹à¤¾à¤ à¤•à¥à¤²à¤¿à¤• à¤•à¤°à¥‡à¤‚à¥¤" },
            { target: 'btn-chat-widget', title: "ðŸ—£ï¸ à¤¸à¤–à¥€ à¤¸à¥‡ à¤¬à¤¾à¤¤ à¤•à¤°à¥‡à¤‚", desc: "à¤¯à¤¹à¤¾à¤ à¤•à¥à¤²à¤¿à¤• à¤•à¤°à¤•à¥‡ à¤…à¤ªà¤¨à¥€ à¤­à¤¾à¤·à¤¾ à¤®à¥‡à¤‚ à¤¸à¤µà¤¾à¤² à¤ªà¥‚à¤›à¥‡à¤‚à¥¤" },
            { target: 'btn-prices', title: "ðŸ’° à¤®à¤‚à¤¡à¥€ à¤­à¤¾à¤µ", desc: "à¤¤à¤¾à¤œà¤¼à¤¾ à¤®à¤‚à¤¡à¥€ à¤­à¤¾à¤µ à¤”à¤° à¤¸à¤°à¤•à¤¾à¤°à¥€ à¤¯à¥‹à¤œà¤¨à¤¾à¤“à¤‚ à¤•à¥‡ à¤²à¤¿à¤ à¤¯à¤¹à¤¾à¤ à¤¦à¥‡à¤–à¥‡à¤‚à¥¤" }
        ],
        // Add other languages as needed...
        'ta': [
            { target: 'btn-analyze', title: "ðŸ“¸ à®¨à¯‹à®¯à¯ à®•à®£à¯à®Ÿà®±à®¿à®¤à®²à¯", desc: "à®¨à¯‹à®¯à¯à®±à¯à®± à®ªà®¯à®¿à®°à¯ˆ à®ªà®Ÿà®®à¯ à®Žà®Ÿà¯à®•à¯à®• à®‡à®™à¯à®•à¯‡ à®•à®¿à®³à®¿à®•à¯ à®šà¯†à®¯à¯à®¯à®µà¯à®®à¯." },
            { target: 'btn-chat-widget', title: "ðŸ—£ï¸ à®šà®•à®¿à®¯à¯à®Ÿà®©à¯ à®ªà¯‡à®šà¯", desc: "à®‰à®™à¯à®•à®³à¯ à®®à¯Šà®´à®¿à®¯à®¿à®²à¯ à®•à¯‡à®³à¯à®µà®¿ à®•à¯‡à®Ÿà¯à®• à®‡à®™à¯à®•à¯‡ à®•à®¿à®³à®¿à®•à¯ à®šà¯†à®¯à¯à®¯à®µà¯à®®à¯." },
            { target: 'btn-prices', title: "ðŸ’° à®šà®¨à¯à®¤à¯ˆ à®µà®¿à®²à¯ˆ", desc: "à®šà®¨à¯à®¤à¯ˆ à®µà®¿à®²à¯ˆ à®®à®±à¯à®±à¯à®®à¯ à®¤à®¿à®Ÿà¯à®Ÿà®™à¯à®•à®³à¯ˆ à®…à®±à®¿à®¯ à®‡à®™à¯à®•à¯‡ à®•à®¿à®³à®¿à®•à¯ à®šà¯†à®¯à¯à®¯à®µà¯à®®à¯." }
        ]
    };

    let currentStep = 0;
    let currentLang = 'en';

    // 1. Detect Lang
    function detectLanguage() {
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('lang')) return urlParams.get('lang');
        const match = document.cookie.match(/googtrans=\/en\/(\w+)/);
        if (match && match[1]) return match[1];
        return 'en';
    }

    // 2. Auto Start
    window.addEventListener('load', () => {
        currentLang = detectLanguage();
        if (!tourData[currentLang]) currentLang = 'en'; // Fallback
        
        if (!localStorage.getItem('seenTour_v1')) {
            setTimeout(() => { startTour(); }, 1000);
        }
    });

    // 3. Start Tour
    function startTour() {
        currentStep = 0;
        document.getElementById('tour-spotlight').style.opacity = '1';
        document.getElementById('tour-tooltip').style.opacity = '1';
        document.getElementById('tour-spotlight').classList.add('spotlight-active');
        document.body.style.overflow = "hidden"; // Disable scroll
        showStep();
    }

    // 4. Show Step Logic (The Maths)
    function showStep() {
        const data = tourData[currentLang][currentStep];
        const targetEl = document.getElementById(data.target);
        const spotlight = document.getElementById('tour-spotlight');
        const tooltip = document.getElementById('tour-tooltip');

        if (!targetEl) { endTour(); return; }

        // Get coordinates
        const rect = targetEl.getBoundingClientRect();
        
        // Move Spotlight
        spotlight.style.width = (rect.width + 10) + 'px';
        spotlight.style.height = (rect.height + 10) + 'px';
        spotlight.style.top = (rect.top - 5) + 'px';
        spotlight.style.left = (rect.left - 5) + 'px';

        // Update Text
        document.getElementById('ttTitle').innerText = data.title;
        document.getElementById('ttDesc').innerText = data.desc;

        // Position Tooltip
        // Check if there is space below, else put above
        const spaceBelow = window.innerHeight - rect.bottom;
        if (spaceBelow > 200) {
            tooltip.style.top = (rect.bottom + 20) + 'px';
            tooltip.style.left = (window.innerWidth / 2 - 140) + 'px'; // Center horizontally
        } else {
            tooltip.style.top = (rect.top - 180) + 'px'; // Put above
            tooltip.style.left = (window.innerWidth / 2 - 140) + 'px';
        }

        // Button Text
        const btn = document.getElementById('ttBtn');
        if (currentStep === tourData[currentLang].length - 1) {
            btn.innerText = "Finish";
        } else {
            btn.innerText = "Next";
        }
    }

    // 5. Next Step
    function nextStep() {
        if (currentStep < tourData[currentLang].length - 1) {
            currentStep++;
            showStep();
        } else {
            endTour();
        }
    }

    // 6. End Tour
    function endTour() {
        document.getElementById('tour-spotlight').style.opacity = '0';
        document.getElementById('tour-tooltip').style.opacity = '0';
        document.body.style.overflow = "auto"; // Re-enable scroll
        setTimeout(() => {
             document.getElementById('tour-spotlight').classList.remove('spotlight-active');
        }, 500);
        localStorage.setItem('seenTour_v1', 'true');
    }
    
    // Handle Window Resize
    window.addEventListener('resize', () => {
        if (document.getElementById('tour-spotlight').style.opacity === '1') {
            showStep();
        }
    });
</script>
{% endblock %}