{% extends 'base.html' %}
{% load static %}

{% block title %}Disease Prediction{% endblock %}

{% block content %}
<div class="loader-overlay" id="loading-spinner">
    <div class="loader-spinner"></div>
    <div class="loader-text" id="loader-text-id">Analyzing... Result generated instantly.</div>
</div>
<style>
    /* CRITICAL FIXES EMBEDDED INLINE for Predict Wizard */
    .predict-container-wizard {
        max-width: 800px;
        margin: 2rem auto;
        background-color: #fff;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        overflow: hidden;
        border: 1px solid #eee;
    }
    .progress-bar-container {
        padding: 2rem 2.5rem 1.5rem 2.5rem;
        background-color: #fcfcfc;
        border-bottom: 1px solid #eee;
    }
    .progress-bar-steps {
        display: flex; justify-content: space-between; align-items: center; position: relative;
    }
    .progress-bar-steps::before {
        content: ''; position: absolute; top: 50%; left: 0; width: 100%; height: 4px; background-color: #f0f0f0;
        z-index: 1; transform: translateY(-50%);
    }
    .progress-bar-line {
        position: absolute; top: 50%; left: 0; width: 0%; height: 4px; background-color: #4CAF50;
        z-index: 2; transform: translateY(-50%); transition: width 0.4s ease;
    }
    .step {
        display: flex; flex-direction: column; align-items: center; z-index: 3;
    }
    .step-label {
        margin-top: 0.5rem; font-weight: 500; color: #999; font-size: 0.9rem; white-space: nowrap; transition: all 0.4s ease;
    }
    .step-circle {
        width: 40px; height: 40px; border-radius: 50%; background-color: #f0f0f0; border: 4px solid #f0f0f0;
        color: #999; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1rem;
        transition: all 0.4s ease;
    }
    .step.active .step-circle { background-color: #fff; border-color: #4CAF50; color: #4CAF50; }
    .step.completed .step-circle { background-color: #4CAF50; border-color: #4CAF50; color: #fff; }
    .step-label { color: #333; font-weight: 600; }
    .form-step {
        display: none; padding: 2rem 2.5rem; animation: fadeIn 0.5s ease;
    }
    .form-step.active { display: block; }
    .form-step h3 {
        margin-bottom: 5px; margin-top: 0; color: #2c5e2e;
    }
    .form-step p {
        margin-bottom: 20px; color: #555; font-size: 1rem;
    }
    .form-group label {
        display: block; margin-bottom: 0.2rem; font-weight: 600; color: #333;
    }
    /* Input Alignment Fix */
    .form-group input,
    .form-group textarea {
        width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box;
        background: #fdfdfd; margin-top: 5px; 
    }
    .form-group textarea { 
        min-height: 100px; 
        resize: vertical; 
    }
    .custom-file-upload {
        border: 2px dashed #a7d3a6; border-radius: 8px; padding: 2.5rem; text-align: center;
        cursor: pointer; background-color: #f1f8e9; transition: background-color 0.3s ease;
    }
    .btn-submit {
        background-color: #4CAF50; color: white; border: none; padding: 13px; border-radius: 10px; cursor: pointer;
        font-size: 17px; transition: all 0.3s ease;
    }
    .btn-nav {
        padding: 0.75rem 1.5rem; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 1rem;
    }
    .btn-prev { background-color: #f0f0f0; color: #555; }
    .form-navigation {
        display: flex; justify-content: space-between; margin-top: 2rem;
    }
</style>
<div class="predict-container-wizard">
    <div class="progress-bar-container">
        <div class="progress-bar-steps">
            <div class="progress-bar-line" id="progress-line"></div>
            
            <div class="step active" id="step-label-1">
                <div class="step-circle">1</div>
                <div class="step-label">Crop Details</div>
            </div>
            
            <div class="step" id="step-label-2">
                <div class="step-circle">2</div>
                <div class="step-label">Upload Image</div>
            </div>
        </div>
    </div>

    <form class="predict-form" method="POST" enctype="multipart/form-data">
        {% csrf_token %}

        {% if error %}
            <div class="error-message" style="margin: 0 2.5rem 1rem 2.5rem;">
                {{ error }}
            </div>
        {% endif %}

        <div class="form-step active" id="step-1">
            <h3>Step 1: Crop Details</h3>
            <p>Tell us about your crop and what you're seeing.</p>
            
            <div class="form-group">
                <label for="crop-type">What crop is this?</label>
                <input type="text" id="crop-type" name="crop-type" placeholder="e.g., Rice, Tomato, Wheat" required>
            </div>
    
            <div class="form-group">
                <label for="symptoms">Describe the symptoms:</label>
                <textarea id="symptoms" name="symptoms" placeholder="e.g., Yellow spots, wilting leaves, powdery white coating..."></textarea>
            </div>
            
            <div class="form-navigation" style="justify-content: flex-end;">
                <button type="button" class="btn-submit" onclick="nextStep(2)">Next &rarr;</button>
            </div>
        </div>

        <div class="form-step" id="step-2">
            <h3>Step 2: Upload Image</h3>
            <p>Upload a clear image of the affected crop leaf.</p>
            
            <div class="form-group">
                <label for="image-input" class="custom-file-upload" id="file-upload-box">
                    <div class="upload-icon">ðŸ“¤</div>
                    <p>Click to upload an image</p>
                    <span>or drag and drop here</span>
                </label>
                <input type="file" id="image-input" name="image" accept="image/*" required style="display: none;">
                <span id="file-name">No file chosen</span>
            </div>
            
            <div class="form-navigation">
                <button type="button" class="btn-nav btn-prev" onclick="prevStep(1)">&larr; Back</button>
                <button type="submit" class="btn-submit" id="analyze-btn" disabled>Analyze Crop</button>
            </div>
        </div>
        
    </form>
</div>
{% endblock %}


{% block scripts %}
<script>
    // --- !! CRITICAL FIX: HIDE PRELOADER IMMEDIATELY !! ---
     
    
    // --- END FIX ---


    // --- Wizard Navigation ---
    const step1 = document.getElementById('step-1');
    const step2 = document.getElementById('step-2');
    const stepLabel1 = document.getElementById('step-label-1');
    const stepLabel2 = document.getElementById('step-label-2');
    const progressLine = document.getElementById('progress-line');

    function nextStep(step) {
        if (step === 2) {
            // Validate Step 1
            const cropType = document.getElementById('crop-type').value;
            if (cropType.trim() === "") {
                alert("Please enter a crop type to continue.");
                return;
            }
            
            step1.classList.remove('active');
            step2.classList.add('active');
            
            stepLabel1.classList.add('completed');
            stepLabel2.classList.add('active');
            progressLine.style.width = '100%';
        }
    }

    function prevStep(step) {
        if (step === 1) {
            step2.classList.remove('active');
            step1.classList.add('active');
            
            stepLabel1.classList.add('active'); // Re-activate
            stepLabel1.classList.remove('completed');
            stepLabel2.classList.remove('active');
            progressLine.style.width = '0%';
        }
    }

    // --- Custom File Upload ---
    const fileUploadBox = document.getElementById('file-upload-box');
    const fileInput = document.getElementById('image-input');
    const fileName = document.getElementById('file-name');
    const analyzeBtn = document.getElementById('analyze-btn');
    const spinner = document.getElementById('loading-spinner');
    const loaderText = document.getElementById('loader-text-id');

    // Trigger file input when custom box is clicked (safely)
    fileUploadBox.addEventListener('click', (e) => {
        if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'SPAN' && e.target.tagName !== 'P') {
            fileInput.click();
        }
    });

    // Handle file selection
    fileInput.addEventListener('change', () => {
        if (fileInput.files.length > 0) {
            fileName.textContent = fileInput.files[0].name;
            analyzeBtn.disabled = false; // Enable submit button
            fileUploadBox.style.borderColor = '#4CAF50'; // Green border
        } else {
            fileName.textContent = 'No file chosen';
            analyzeBtn.disabled = true; // Disable submit
            fileUploadBox.style.borderColor = '#a7d3a6'; // Reset border
        }
    });

    // --- Script to show the *other* spinner (the simple overlay) on submit ---
    const predictForm = document.querySelector('.predict-form');
    
    predictForm.addEventListener('submit', function() {
        if (fileInput.files.length > 0) {
            // Use the standard loader overlay from global styles
            const loader = document.getElementById('loading-spinner');
            if (loader) loader.style.display = 'flex';
        } else {
            alert('Please upload an image first.');
            return false; // Stop the form from submitting
        }
    });
</script>
{% endblock %}