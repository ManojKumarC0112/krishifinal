{% extends 'base.html' %}
{% load static %} 

{% block title %}AI Crop Guardian: Analysis Results{% endblock %}

{% block styles %}
<style>
    /* --- Main Layout --- */
    .result-container {
        display: flex;
        flex-wrap: wrap;
        gap: 2.5rem; /* Increased gap for separation */
        max-width: 1300px; /* Increased max-width */
        margin: 1rem auto;
        padding: 0 1rem;
    }

    /* Video Column */
    .video-column {
        flex: 1;
        min-width: 350px; /* Minimum width ensures it doesn't squash */
    }
    .video-column video {
        width: 100%;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        border: 1px solid #ddd;
    }

    /* Details Column */
    .details-column {
        flex: 1.5;
        min-width: 350px;
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    .result-card {
        background-color: #fff;
        border-radius: 12px;
        padding: 2rem;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        border: 1px solid #eee;
        flex-shrink: 0;
    }

    .result-card h2 {
        color: #2c5e2e;
        margin-top: 0;
        margin-bottom: 0.5rem;
    }

    .result-card h3 {
        color: #333;
        border-bottom: 2px solid #f0f0f0;
        padding-bottom: 0.5rem;
        margin-top: 1.5rem;
        margin-bottom: 1rem;
        font-size: 1.4rem;
    }
    
    /* --- Progress Circle Styles --- */
    .progress-circle {
        position: relative;
        width: 150px;
        height: 150px;
        border-radius: 50%;
        margin: 0 auto 1.5rem;
        display: flex;
        justify-content: center;
        align-items: center;
        background: radial-gradient(white 55%, transparent 56%),
                    conic-gradient(#4CAF50 0%, #4CAF50 var(--progress, 0%), #f0f0f0 var(--progress, 0%), #f0f0f0 100%);
        border: 2px solid #ddd;
        font-size: 2rem;
        font-weight: bold;
        color: #2c5e2e;
        transition: all 0.5s ease;
    }
    .progress-circle::after {
        content: "%";
        font-size: 1.5rem;
        margin-left: 5px;
        font-weight: 500;
    }
    
    .score-low { --progress: 30%; background: conic-gradient(#f44336 0%, #f44336 var(--progress), #f0f0f0 var(--progress), #f0f0f0 100%); color: #f44336; border-color: #f44336; }
    .score-medium { --progress: 60%; background: conic-gradient(#ff9800 0%, #ff9800 var(--progress), #f0f0f0 var(--progress), #f0f0f0 100%); color: #ff9800; border-color: #ff9800;}
    .score-high { --progress: 90%; background: conic-gradient(#4CAF50 0%, #4CAF50 var(--progress), #f0f0f0 var(--progress), #f0f0f0 100%); color: #4CAF50; border-color: #4CAF50;}


    /* --- Alerts & Action Plan Styles (Unchanged) --- */
    .alerts-list {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }
    .alert-item {
        padding: 1rem;
        border-radius: 8px;
        font-weight: 500;
        border-left: 5px solid;
    }
    .alert-item strong { font-weight: 700; }
    .alert-disease { border-color: #d32f2f; background: #ffebee; } /* Red */
    .alert-weed { border-color: #ffc107; background: #fff8e1; } /* Yellow */
    .alert-dryness { border-color: #2196f3; background: #e3f2fd; } /* Blue */
    .alert-other { border-color: #795548; background: #fbe9e7; } /* Brown */

    .action-plan-list {
        list-style: none;
        padding: 0;
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }
    .action-plan-list li {
        display: flex;
        align-items: flex-start;
        gap: 1rem;
        padding: 0.75rem;
        background: #f9f9f9;
        border-radius: 8px;
        border: 1px solid #eee;
        font-size: 1.05rem;
    }
    .action-plan-list li::before {
        content: "üõ†Ô∏è";
        font-size: 1.2rem;
        flex-shrink: 0;
    }

    /* --- Status/Loader Page Styles (for PENDING/ANALYZING) --- */
    .loading-page-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        padding: 4rem;
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        max-width: 600px;
        margin: 4rem auto;
    }
    .loading-page-container h1 {
        color: #2c5e2e;
        margin-top: 1.5rem;
    }
    .loading-page-container p {
        font-size: 1.1rem;
        color: #555;
        margin-top: 1rem;
    }
    .loading-spinner-large {
        border: 10px solid #f3f3f3;
        border-top: 10px solid #4CAF50;
        border-radius: 50%;
        width: 80px;
        height: 80px;
        animation: spin 1s linear infinite;
    }
    
    /* Status specific colors */
    .status-completed { background: #e8f5e9; border-left: 5px solid #4CAF50; padding: 1rem; border-radius: 8px; }
    .status-failed { background: #ffebee; border-left: 5px solid #f44336; padding: 1rem; border-radius: 8px; }
    
    @media (max-width: 768px) {
        .result-container {
            flex-direction: column;
            gap: 1.5rem;
        }
        .video-column, .details-column {
            min-width: 100%;
        }
    }


</style>
{% endblock %}


{% block content %}

{% if status == 'PENDING' or status == 'ANALYZING' %}

    <div class="loading-page-container" id="processing-status-container">
        <div class="loading-spinner-large"></div>
        <h1>AI Analysis In Progress...</h1>
        <p>This is the crucial step. Sakhi AI is now analyzing the full video for growth patterns, disease, and uniformity.</p>
        <p style="font-weight: bold; margin-top: 2rem;">Current Status: <span id="current-status">{{ status }}</span></p>
        <p style="font-size: 0.9rem; color: #777;">Please keep this window open. This process may take 30-60 seconds.</p>
    </div>
    
{% else %} 

    {% if status == 'FAILED' %}
        <div class="status-failed">
            <h2>üö® Analysis Failed</h2>
            <p>{{ details.error|default:"An unknown error occurred during video processing. Please check the video format and size (max 150MB) and try again." }}</p>
        </div>
        <a href="{% url 'video_analysis_upload' %}" class="btn-submit" style="margin: 1rem auto; display: block; width: 250px; text-align: center; text-decoration: none;">Try New Upload</a>
        
    {% elif status == 'COMPLETED' %}
        
        <div class="result-container">
            
            <div class="video-column">
                <h2>Field Video (Weekly Check)</h2>
                <video src="{{ video_record.video_file.url }}" controls muted loop></video>
                <div class="status-completed" style="margin-top: 1rem;">
                    <strong>Video ID:</strong> {{ video_record.id }} | 
                    <strong>Date:</strong> {{ video_record.date|date:"F d, Y" }}
                </div>
            </div>

            <div class="details-column">
                
                <div class="result-card">
                    <h2>AI Crop Guardian Report</h2>
                    <p style="font-size: 1.1rem; color: #555;">
                        Overall Health Score for the field: 
                        <strong style="color: #2c5e2e;">{{ details.crop_health|default:"N/A" }}%</strong>
                    </p>
                    
                    {% with health_score=details.crop_health|default:50 %}
                        {% if health_score < 40 %}
                            {% with score_class='score-low' %} {% endwith %}
                        {% elif health_score < 75 %}
                            {% with score_class='score-medium' %} {% endwith %}
                        {% else %}
                            {% with score_class='score-high' %} {% endwith %}
                        {% endif %}
                    {% endwith %}

                    <div class="progress-circle {{ score_class }}" style="--progress: {{ details.crop_health|default:0 }}%;">
                        {{ details.crop_health|default:"N/A" }}
                    </div>
                    
                    <h3 style="margin-top: 0;">Pattern Analysis</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="stat-card">
                            <strong>Growth (Last Week)</strong>
                            <p style="color: #4CAF50; font-weight: bold; font-size: 1.2rem;">+{{ details.growth_percentage|default:"N/A" }}%</p>
                        </div>
                        <div class="stat-card">
                            <strong>Plant Uniformity</strong>
                            <p style="color: #2196f3; font-weight: bold; font-size: 1.2rem;">{{ details.uniformity|default:"N/A" }}</p>
                        </div>
                    </div>
                </div>

                <div class="result-card">
                    <h3>‚ö†Ô∏è Alerts & Problem Zones</h3>
                    
                    {% if details.alerts %}
                        <div class="alerts-list">
                            {% for alert in details.alerts %}
                                {% with alert_type=alert.type|default:"Other"|lower %}
                                    <div class="alert-item 
                                        {% if 'disease' in alert_type %}alert-disease
                                        {% elif 'weed' in alert_type %}alert-weed
                                        {% elif 'dryness' in alert_type %}alert-dryness
                                        {% else %}alert-other
                                        {% endif %}">
                                        <strong>{{ alert.type|default:"Issue" }}:</strong> {{ alert.summary|default:"Details unavailable." }} 
                                        (<span style="font-weight: bold;">Severity: {{ alert.severity|default:"Low" }}</span>)
                                    </div>
                                {% endwith %}
                            {% endfor %}
                            
                            <p style="margin-top: 1rem;">
                                **Detected Problem Zones:** {{ details.problem_zones|join:", "|default:"None identified." }}
                            </p>
                        </div>
                    {% else %}
                        <p>‚úÖ Great news! No critical disease or dryness alerts were generated from this week's video.</p>
                    {% endif %}
                </div>
                
                <div class="result-card">
                    <h3>üõ†Ô∏è Action Plan</h3>
                    {% if details.action_plan %}
                        <ul class="action-plan-list">
                            {% for action in details.action_plan %}
                                <li>{{ action }}</li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p>No immediate action plan required based on current video analysis. Continue weekly monitoring.</p>
                    {% endif %}
                </div>

            </div>
        </div>
        
    {% endif %}

{% endif %}

{% endblock %}


{% block scripts %}
<script>
    // --- Video Processing Poll Script ---
    var videoId = {{ video_record.id }}; 
    
    const processingContainer = document.getElementById('processing-status-container');
    const currentStatusSpan = document.getElementById('current-status');
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    const isProcessingPage = processingContainer !== null;
    
    // Sequence of loader messages for suspense
    const loaderMessages = [
        "Starting complex AI video stream analysis...",
        "Identifying specific growth patterns and crop density...",
        "Scanning for weed infiltration and dry patches...",
        "Comparing current metrics against last week's baseline...",
        "Finalizing disease detection algorithms...",
        "Generating structured action plan and health score..."
    ];
    let messageIndex = 0;
    let pollInterval = null; 

    // Update the processing status text every few seconds
    function updateLoaderMessage() {
        if (currentStatusSpan) {
            currentStatusSpan.textContent = loaderMessages[messageIndex];
            messageIndex = (messageIndex + 1) % loaderMessages.length;
        }
    }
    
    // --- Polling function to check server status ---
    function checkAnalysisStatus() {
        const apiUrl = `/api/process-video/${videoId}/`;

        fetch(apiUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({})
        })
        .then(response => {
            if (!response.ok) {
                if (response.status === 403) {
                     throw new Error('Authentication/CSRF token failed. Please refresh and log in.');
                }
                return response.json().catch(() => {
                    throw new Error(`Server API check failed with status: ${response.status}`);
                });
            }
            return response.json();
        })
        .then(data => {
            if (data.status === 'COMPLETED' || data.status === 'FAILED') {
                clearInterval(pollInterval);
                window.location.reload(); 
            } else if (data.status === 'ANALYZING') {
                if (currentStatusSpan) {
                     currentStatusSpan.textContent = loaderMessages[messageIndex];
                }
            }
        })
        .catch(error => {
            console.error('Polling/API error:', error);
            clearInterval(pollInterval);
            if (processingContainer) {
                processingContainer.innerHTML = `
                    <h1 style="color: red;">Analysis Interrupted / Login Required</h1>
                    <p>Error: ${error.message}</p>
                    <button class="btn-submit" onclick="window.location.reload()" style="margin-top: 1rem;">Retry / Log In</button>
                `;
            }
        });
    }

    if (isProcessingPage) {
        
        updateLoaderMessage(); 
        checkAnalysisStatus();
        
        pollInterval = setInterval(() => {
             updateLoaderMessage();
             checkAnalysisStatus(); 
        }, 5000); 
    }
    
</script>
{% endblock %}